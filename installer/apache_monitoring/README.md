# Plugin for Apache Monitoring

The Apache HTTP Server, commonly known as Apache, is the world's most used web server software. Configure the Site24x7 Apache plugin to monitor the performance of your Apache server and stay on top of issues at all times.

## Quick installation
If you're using Linux servers, use the Apache plugin installer that checks the prerequisites and installs the plugin with a bash script. You don't need to manually set up the plugin if you're using the installer.

Execute the command below in the terminal to run the installer and follow the instructions displayed on-screen:
```bash
wget https://raw.githubusercontent.com/site24x7/plugins/master/apache_monitoring/InstallSite24x7ApachePlugin.sh && sudo bash InstallSite24x7ApachePlugin.sh
```

## Standard installation
If you're not using Linux servers or want to install the plugin manually, follow the steps below.

### Prerequisites

Download and install the latest version of the [Site24x7 Linux agent](https://www.site24x7.com/app/client#/admin/inventory/add-monitor) in the server where you plan to run the plugin.

#### Perform the following configuration in the Apache configuration file to get the performance metrics - 
1. Enable mod_status

- Apache configuration file is located at one of the following locations, depending on your Linux distribution.
	```
	/etc/apache2/httpd.conf
	/etc/apache2/apache2.conf
	/etc/httpd/httpd.conf
	/etc/httpd/conf/httpd.conf
	```

- Open the terminal and run the following command to open the Apache configuration file "/etc/httpd/conf/httpd.conf".

  	```
  	sudo vi /etc/httpd/conf/httpd.conf
   	```

- In the file "/etc/httpd/conf/httpd.conf", search for the following line

	```apacheconf
 	#LoadModule status_module modules/mod_status.so
  	```

- Uncomment the above line by removing # at its beginning.

	```apacheconf
 	LoadModule status_module modules/mod_status.so
 	```


2. Configure mod_status in Apache configuration "/etc/httpd/conf/httpd.conf" file

- Search for the following block of code 
	```apacheconf
	# Allow server status reports generated by mod_status,
	# with the URL of http://servername/server-status
	# Change the ".example.com" to match your domain to enable.
	#
	#<location server-status="">
	#    SetHandler server-status
	#</location>
	```

- Uncomment the location block by removing # in front of its lines, and update the Allow, Order and Deny directives as shown below.
	```apacheconf
	<Location /server-status>
		SetHandler server-status
		Require local
	</Location>
	```

The above configuration works for the default Apache configuration. If you want to change the URL at which the dashboard is available, then change /server-status in the location tag as per your requirement.


- Also, this configuration will not work for Virtual Hosts. If you have configurated Virtual Hosts, then you need to place this location block inside the VirtualHost block, as shown below.

	```apacheconf		
	<VirtualHost *:80>
 		...
		<Location /server-status>
			SetHandler server-status
			Require local
		</Location>
 		...
	</VirtualHost>
	```
 
3. After completing all the changes restart the Apache server using the below Linux command.

 	```
	service apache restart
	```
  
4. After following the above steps execute the command below to verify the accessibility of the apache2 stats page.

 	```
	curl -I http://localhost:80/server-status?auto
	```
	
	```
	HTTP/1.1 200 OK
	Date: Fri, 21 Apr 2023 10:11:01 GMT
	Server: Apache/2.4.52 (Ubuntu)
	Vary: Accept-Encoding
	Content-Length: 3864
	Content-Type: text/html; charset=ISO-8859-1

	```
	It can also be manually checked using the browser by entering the below URL.
	```
	http://localhost:80/server-status?auto
	```
 
**Note :** The URL will differ based on what you have entered in the Apache configuration.

### Add Plugin   

1. Create a folder named _apache\_monitoring_.

2. Download the [apache\_monitoring.py](https://raw.githubusercontent.com/site24x7/plugins/master/apache\_monitoring/apache_monitoring.py) and the [apache\_monitoring.cfg](https://raw.githubusercontent.com/site24x7/plugins/master/apache\_monitoring/apache_monitoring.cfg) files from our [GitHub repository](https://github.com/site24x7/plugins), and place them in the _apache\_monitoring_ folder.  

	```bash
	wget https://raw.githubusercontent.com/site24x7/plugins/master/apache_monitoring/apache_monitoring.py && sed -i "1s|^.*|#! $(which python3)|" apache_monitoring.py
	wget https://raw.githubusercontent.com/site24x7/plugins/master/apache_monitoring/apache_monitoring.cfg
	```
 
3. To check if the plugin is working, execute the command below with appropriate arguments and check for a valid JSON output with applicable metrics and their corresponding value.  

	```bash
	python3 apache_monitoring.py --url "http://localhost:80/server-status?auto" --username "apache username" --password "apache password"
	```

4. Add the applicable configurations in the _apache\_monitoring.cfg_ file.  
	You can also configure [Apache access logs](https://www.site24x7.com/help/log-management/apache-access.html) to view the top failed requests, the URLs that take the longest to retrieve data, and more.

	```bash
	[localhost]
	url ="http://localhost:80/server-status?auto"
	username=None
	password =None
	timeout="30"
	plugin_version ="1"
	heartbeat ="true"
	logs_enabled ="true"
	log_type_name ="Apache Access Logs"
	log_file_path ="/var/log/apache2/access.log"
	```

6. Follow the steps in this [article](https://support.site24x7.com/portal/en/kb/articles/run-python-plugin-scripts-in-windows-servers) to learn how to run the Python script on a Windows server. You don't need to do this for Linux.  

7. If you have virtual hosts configured and/or need to monitor the status of multiple domains using the same plugin, refer [this link](https://www.site24x7.com/help/admin/adding-a-monitor/plugins/custom-plugins.html#multiple-config) to configure the domains.

8. Move the _apache\_monitoring_ folder to the _Site24x7 server monitoring plugins directory_.

	- For Linux: `/opt/site24x7/monagent/plugins/`

	- For Windows: `C:\Program Files (x86)\Site24x7\WinAgent\monitoring\plugins\`

The agent will automatically execute the plugin within five minutes and display performance data in Site24x7.

To view the plugin monitor and associated performance charts:

1. Log in to Site24x7.

2. Navigate to **Plugins** and click the required monitor.

#### **Troubleshooting Tips**

- [Configure status URL for Apache monitoring](https://support.site24x7.com/portal/en/kb/articles/configure-status-url-apache)

- [Enable SSL for Apache monitoring](https://support.site24x7.com/portal/en/kb/articles/enable-ssl)

- [Change the port for Apache monitoring](https://support.site24x7.com/portal/en/kb/articles/change-port)

- [Error handling for Apache monitoring](https://www.site24x7.com/help/admin/adding-a-monitor/plugins/plugins-error-handling.html)



## Performance Metrics
Name		            	| 	Description
---         		   	|   	---
Requests per Second		|	req_per_sec records the total number of HTTP requests the web server is processing per second.
Busy Workers			|	Use the metric busy_workers to get the total number of processes actively processing an HTTP request.
Idle Workers			|	idle_workers is the total number of idle workers/idle processes waiting for an HTTP request.
Bytes per Second		|	bytes_per_sec records the total amount of data the web server is transferring per second.
Bytes per Request		|	The average number of bytes being transferred per HTTP request is obtained using the metric bytes_per_req.
Processes			|	Processes denote the number of async processes.
Connections Async Closing	|	Connections Async Closing shows the number of async connections that are in the closing state.
Connections Async Keep Alive	|	Connections Async Keep Alive displays the number of async connections that are in the keep-alive state.
Connections Async Writing	|	Connections Async Writing denotes the number of async connections that are in the writing state.
CPU Load			|	Use the metric cpu_load and get the total percentage of CPU used by the web server.
CPU System			|	CPU System shows the percentage of time taken by the Apache process to access the system resources.
CPU User			|	CPU User displays the percentage of time taken by the Apache process to process the code.
Load1				|	Load1 shows the one-minute load average.
Load5				|	Load5 denotes the five-minute load average.
Load15				|	Load15 displays the 15-minute load average.
Total Accesses			|	The total number of accesses on the server is monitored using the metric total_accessess.
Total Connections		|	Total Connections depicts the total number of connections on the Apache server.
Total kbytes			|	Total kbytes records the total kilobytes served.
Uptime				|	Uptime shows the total amount of time the server has been up and running.
Version				|	Version denotes the Apache server version.
